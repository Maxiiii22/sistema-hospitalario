{% extends 'layout/base-personal.html' %}
{% load static %}

{% block css %}
    <link rel="stylesheet" href="{% static 'estilos/styles_administrador.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}
    
{% block titulo %}
    <title>Reportes de Consultas del Hospital</title>
{% endblock %}

{% block contenido %}
<div class="body-reportes">
    <div class="container-reporte">
        <a id="back-link-solo" href="{% url 'indexPersonal' %}" class="back-link"><i class="hgi hgi-stroke hgi-arrow-left-02"></i> Volver al inicio</a>
        <h1 class="title-reporte">Reportes de Consultas del Hospital</h1>

        <form id="form-reporte" method="get">
            <div class="campos-form-reportes">
                <div class="campo-input">
                    <label>Tipo:</label>
                    <select name="tipo" id="tipo_reporte">
                        <option value="diario" {% if tipo_reporte == "diario" %}selected{% endif %}>Diario</option>
                        <option value="mensual" {% if tipo_reporte == "mensual" %}selected{% endif %}>Mensual</option>
                    </select>
                </div>

                <div class="campo-input">
                    <label>Año:</label>
                    <input type="number" name="anio" value="{{fecha_inicio.year}}" min="2000" max="2100" required>
                </div>

                <div class="campo-input">
                    <label>Mes:</label>
                    <input type="number" name="mes" value="{{fecha_inicio.month}}" min="1" max="12" required>
                </div>
                
                <div class="campo-input" id="campo-input-dia">
                    <label id="label-dia">Día:</label>
                    <input type="number" name="dia" id="input-dia" value="{{fecha_inicio.day}}" min="1" max="31" {% if tipo_reporte == "mensual" %}disabled style="display:none"{% endif %}>
                </div>
            </div>

            <div class="btn-form-reportes">
                <button type="submit">Generar reporte</button>
            </div>

        </form>

        <div class="tarjetas" id="tarjetas"></div>

        <div class="tabla-reportes-container">
            <table class="tabla-reportes">
                <thead>
                    <tr>
                        <th>Especialidad</th>
                        <th>Consultas</th>
                    </tr>
                </thead>
                <tbody id="tabla"></tbody>
            </table>
        </div>

        <div class="grafica-container">
            <canvas id="grafica"></canvas>
        </div>
    </div>  
</div>

{% endblock %}

{% block scripts_js %} 
    <script>
        const tipoSelect = document.getElementById("tipo_reporte");
        const campoDia = document.getElementById("campo-input-dia");
        const inputDia = document.getElementById("input-dia");

        function comprobar(){
            if (tipoSelect.value === "mensual") {
                campoDia.style.display = "none";
                inputDia.disabled = true;
            } else {
                campoDia.style.display = "block";
                inputDia.style.display = "block";
                inputDia.disabled = false;
            }        
        }
        tipoSelect.addEventListener("change", comprobar)
        comprobar();

        const diario = {
            total: {{diario.total|default:0}},
            totalAtendidas: {{diario.totalAtendidas|default:0}},
            nuevos: {{diario.nuevos_pacientes|default:0}},
            cancelaron: {{diario.cancelaron|default:0}},
            noAsistieron: {{diario.noAsistieron|default:0}},
            detalle: [
                {% for c in diario.detalle %}
                    { especialidad: "{{c.turno__especialidad__nombre_especialidad}}", consultas: {{c.total}} }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        };

        const mensual = {
            total: {{mensual.total|default:0}},
            totalAtendidas: {{mensual.totalAtendidas|default:0}},
            nuevos: {{mensual.nuevos_pacientes|default:0}},
            cancelaron: {{mensual.cancelaron|default:0}},
            noAsistieron: {{mensual.noAsistieron|default:0}},
            detalle: [
                {% for c in mensual.detalle %}
                    { especialidad: "{{c.turno__especialidad__nombre_especialidad}}", consultas: {{c.total}} }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        };

        let chart = null;

        function mostrar(data) {
            
            let filas = "";
            if(data.detalle.length === 0){
                document.querySelector(".grafica-container").style.display = "none";

                filas = `
                <tr class="empty-message">
                    <td colspan="2" class="sin-datos">No hay consultas en este período</td>
                </tr>
                `;                    
                        
            }
            else{
                document.getElementById("tarjetas").innerHTML = `
                <div class="tarjeta"><h3>Total de consultas</h3><p>${data.total}</p></div>
                <div class="tarjeta"><h3>Consultas atendidas</h3><p>${data.totalAtendidas}</p></div>
                <div class="tarjeta"><h3>Pacientes nuevos</h3><p>${data.nuevos}</p></div>
                <div class="tarjeta"><h3>Pacientes que no asistieron</h3><p>${data.noAsistieron}</p></div>
                <div class="tarjeta"><h3>Consultas canceladas</h3><p>${data.cancelaron}</p></div>
                `;    
                
                data.detalle.forEach(x => {
                    filas += `<tr><td>${x.especialidad}</td><td>${x.consultas}</td></tr>`;
                });

                document.querySelector(".grafica-container").style.display = "block";
                const ctx = document.getElementById("grafica");

                if (chart) chart.destroy();

                chart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: data.detalle.map(x => x.especialidad),
                        datasets: [{
                            label: "Consultas",
                            data: data.detalle.map(x => x.consultas),
                            backgroundColor: "#025"
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });           
            }

            document.getElementById("tabla").innerHTML = filas;


        }

        function tieneDatos(data) {
            return data.total > 0 || (data.detalle && data.detalle.length > 0);
        }


        mostrar(diario);
        if (tieneDatos(diario)) {
            mostrar(diario);
        } else if (tieneDatos(mensual)) {
            mostrar(mensual);
        }
    </script>
{% endblock %}
